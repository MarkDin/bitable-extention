# 飞书卡片模板配置指南

本文档介绍如何在飞书开放平台配置操作日志卡片模板。

## 1. 创建卡片模板

### 步骤1：访问飞书开放平台
1. 打开 [飞书开放平台](https://open.feishu.cn/)
2. 登录并进入"开发者后台"
3. 选择或创建你的应用

### 步骤2：进入搭建工具
1. 在应用管理页面，找到"机器人"功能
2. 点击"卡片搭建工具"
3. 创建新的卡片模板

### 步骤3：设计卡片布局
根据操作日志的内容，建议创建包含以下元素的卡片：

#### 卡片标题
- 设置为："📊 提交补全"

#### 卡片内容区域
建议包含以下信息区块：

1. **时间信息**
   - 提交时间：`${start_time}`
   - 完成时间：`${end_time}`

2. **补全信息**
   - 补全数据量：`${complete_row_count}`
   - 补全字段数：从 `${field_list}` 中解析
   - 补全文档：链接到 `${doc_link}`

3. **补全结果**
   - 补全结果：`${complete_result}`

## 2. 配置模板变量

在搭建工具中，需要创建以下变量：

| 变量名称 | 变量API名称 | 类型 | 描述 | 示例值 |
|---------|------------|------|------|--------|
| field_list | var_mciwqaaq | text | 补全的字段 | "补全3个字段: ETA、价格、到期时间" |
| complete_row_count | var_mciwqaat | integer | 补全行数 | 2 |
| start_time | var_mciwqaca | text | 补全开始时间 | "2025/06/06 14:11:12" |
| end_time | var_mciwqaci | text | 补全结束时间 | "2025/06/06 14:11:12" |
| complete_result | var_mciwqael | text | 补全结果 | "✅全部正确" |
| doc_link | var_mciwqajb | text | 多维表格链接 | "https://..." |

**重要说明：**
- 在飞书搭建工具中，使用 **变量名称**（如 `field_list`）来引用变量
- **变量API名称**（如 `var_mciwqaaq`）是系统自动生成的，在代码中不需要使用
- 发送卡片时，使用变量名称作为 template_variable 的 key

## 3. 获取模板配置信息

### 步骤1：复制模板ID
1. 在卡片模板列表中，找到你创建的模板
2. 点击"复制模板ID"
3. 得到类似 `AAqyBQVmUNxxx` 的模板ID

### 步骤2：发布并获取版本号
1. 完成卡片设计后，点击"发布"
2. 在版本管理中查看版本号，如 `1.0.0`

### 步骤3：配置到代码中
将获取的信息更新到 `client/src/lib/sendLarkMessage.ts` 文件中：

```typescript
const CARD_TEMPLATE_CONFIG = {
  template_id: 'YOUR_TEMPLATE_ID_HERE',        // 替换为实际的模板ID
  template_version_name: 'YOUR_VERSION_HERE'   // 替换为实际的版本号
};
```

## 4. 测试卡片发送

### 测试步骤
1. 保存配置文件
2. 重新构建项目
3. 执行一次字段补全操作
4. 检查飞书群聊是否收到卡片消息

### 调试提示
- 检查浏览器控制台的日志输出
- 确认模板ID和变量名称正确
- 验证webhook地址可以正常访问

## 5. 卡片样式建议

### 布局建议
- 使用卡片header显示操作类型
- 用分割线区分不同信息块
- 重要信息用醒目颜色标识

### 颜色方案
- 成功：绿色 (green)
- 部分成功：橙色 (orange) 
- 失败：红色 (red)
- 无权限：红色 (red)
- 无变化：蓝色 (blue)

## 6. 故障排除

### 常见问题

**Q: 发送失败，返回template not found**
A: 检查模板ID是否正确，确认模板已发布

**Q: 变量显示异常**
A: 检查变量API名称是否与代码中的映射一致

**Q: 卡片样式显示不正确**
A: 检查模板版本号，确认使用的是正确版本

**Q: webhook调用失败**
A: 检查机器人是否已加入目标群聊，webhook地址是否正确

### 日志排查
查看浏览器控制台中的日志：
- `[SendLarkMessage] 发送飞书卡片模板:` - 查看发送的数据
- `[SendLarkMessage] 发送成功:` - 查看返回结果
- `[SendLarkMessage] 发送失败:` - 查看错误信息

## 7. 安全注意事项

1. **敏感信息保护**
   - 不要在卡片中显示敏感的业务数据
   - webhook地址应妥善保管

2. **访问控制**
   - 确保机器人只加入了合适的群聊
   - 定期检查和更新webhook地址

3. **数据合规**
   - 遵守公司的数据安全规范
   - 避免发送个人隐私信息

## 更新日志

- 2024-01-XX: 初始版本，支持基础操作日志卡片
- 预计更新: 支持更多卡片模板样式和交互功能 